Option Compare Database
Option Explicit

Private Sub Cmb_現品票番号_Enter()
    Dim Ret As Boolean
    
    ' 再切の現品票番号を取得
    Ret = EditQuery_T_SAISETU_GENPIN()
End Sub

Private Sub Cmb_投入課コード_AfterUpdate()
On Error Resume Next
    'Me![Cmb_投入課コード]の値をローカル汎用マスタに保存する。
    Dim DB1 As DAO.Database
    Dim RS1 As DAO.Recordset
    Set DB1 = CurrentDb
    Set RS1 = DB1.OpenRecordset("Q_TM_HANYOU_LOCAL_XV", dbOpenDynaset)
    If Not RS1.EOF Then
        RS1.MoveFirst
        If Not RS1.EOF Then
            RS1.Edit
               RS1("CODE") = Me![Cmb_投入課コード]
            RS1.Update
        End If
    End If
    Call EditQuery_PQ_抽出条件
    
    If Me.Cmb_投入課コード = "(すべて)" Then
        Me.Filter = "[ItemNumber] = 0 AND [Argument] = 'すべて' "
    Else
        Me.Filter = "[ItemNumber] = 0 AND [Argument] = '課別' "
    End If
    Me.FilterOn = True
    Me.Refresh
    
    Call 投入日始点コンボ_Enter     'V1.040 Add
    
End Sub

Private Sub Form_Close()
    Dim SQL As String
    Dim DB As DAO.Database

'*------------*
'*   主処理   *
'*------------*
    
    Set DB = CurrentDb
    
    SQL = "DELETE * FROM T_BUZAI"
    DB.Execute SQL
    SQL = "DELETE * FROM T_BUZAI_LOT"
    DB.Execute SQL
    SQL = "DELETE * FROM T_KSUNPO"
    DB.Execute SQL
    SQL = "DELETE * FROM T_SEIHIN"
    DB.Execute SQL
    SQL = "DELETE * FROM T_SEIHIN_LOT"
    DB.Execute SQL
    SQL = "DELETE * FROM T_SUNPO"
    DB.Execute SQL
    SQL = "DELETE * FROM T_TEIS"
    DB.Execute SQL
    SQL = "DELETE * FROM T_THARAI"
    DB.Execute SQL
'V1.020 Add Start
    SQL = "DELETE * FROM T_HANYOU"
    DB.Execute SQL
    SQL = "DELETE * FROM T_KAKOU"
    DB.Execute SQL
    SQL = "DELETE * FROM T_KAKOU_KEY"
    DB.Execute SQL
    SQL = "DELETE * FROM T_KAKOU_LABEL"
    DB.Execute SQL
    SQL = "DELETE * FROM T_KAKOU_SAGYO"
    DB.Execute SQL
    SQL = "DELETE * FROM T_PQ_R04_VT_製品累積の抽出"
    DB.Execute SQL
    SQL = "DELETE * FROM T_PQ_R04_VT_製品累積の抽出_ロットまとめ"
    DB.Execute SQL
    SQL = "DELETE * FROM T_R_着工指示書_グループ"
    DB.Execute SQL
    SQL = "DELETE * FROM T_R13_部品ピッキングリスト"
    DB.Execute SQL
    SQL = "DELETE * FROM T_R13_部品ピッキングリスト_グループ"
    DB.Execute SQL
    SQL = "DELETE * FROM T_R13_部品ピッキングリスト_部材"
    DB.Execute SQL
    SQL = "DELETE * FROM T_R14_部品ピッキングリスト_まとめ集計"
    DB.Execute SQL
    SQL = "DELETE * FROM T_R19_部品ピッキングリスト同梱"
    DB.Execute SQL
    SQL = "DELETE * FROM T_R19_部品ピッキングリスト同梱_明細"
    DB.Execute SQL
    SQL = "DELETE * FROM T_TNPLAN"
    DB.Execute SQL
    SQL = "DELETE * FROM T_業務帳票標記"
    DB.Execute SQL
    SQL = "DELETE * FROM T_資材部品調達明細"
    DB.Execute SQL
    SQL = "DELETE * FROM T_窓種別投入一覧"
    DB.Execute SQL
    SQL = "DELETE * FROM T_帳票出力製品累積キー"
    DB.Execute SQL
    SQL = "DELETE * FROM T_部品払出票"
    DB.Execute SQL
    SQL = "DELETE * FROM T_部品払出明細"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_BPSYS_集計"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_WL_C2"
    DB.Execute SQL
'V1.080 Del    SQL = "DELETE * FROM TW_部品ピッキングリスト_整理番号KEY"
'V1.080 Del    DB.Execute SQL
'V1.020 Add End
'V1.021 Add Start
    SQL = "DELETE * FROM T_集積票"
    DB.Execute SQL
    SQL = "DELETE * FROM T_グレチャン払出指示書"
    DB.Execute SQL
    SQL = "DELETE * FROM T_抽出済データ WHERE 内容 <> '最終'"
    DB.Execute SQL
'V1.021 Add End
    SQL = "DELETE * FROM T_VT_部材累積"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_KAKOU_KEY"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_KAKOU_SSUNPO"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_KAKOU_SSUNPO_NO2"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_KAKOU_TEISUKEI"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_KAKOU_TEISYAKU"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_QRコード"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_TEIS_HASIZAI_HITUYOUCHOU"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_フリクションステー"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_ページ連番"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_加工エリア"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_加工パターン条件"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_加工指示"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_加工寸法条件"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_帳票累積11"    'V1.040 Add
    DB.Execute SQL                         'V1.040 Add
    SQL = "DELETE * FROM TW_帳票累積21"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_帳票累積30"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_帳票累積31"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_伝票枚数"
    DB.Execute SQL
'V1.180 Add
    SQL = "DELETE * FROM TW_帳票累積22"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_帳票累積23"
    DB.Execute SQL
'V1.180 Add
'V1.210 Add
    SQL = "DELETE * FROM TW_帳票累積52"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_帳票累積53"
    DB.Execute SQL
'V1.210 Add
    SQL = "DELETE * FROM T_SAGYOJUN"        'V1.090 Add
    DB.Execute SQL                          'V1.090 Add
    SQL = "DELETE * FROM TW_HOKYOU_HACYU"   'V1.130 Add
    DB.Execute SQL                          'V1.130 Add
    SQL = "DELETE * FROM TW_KONPO"          'V1.140 Add
    DB.Execute SQL                          'V1.140 Add
    SQL = "DELETE * FROM TW_KONPO_集計"     'V1.140 Add
    DB.Execute SQL                          'V1.140 Add
'V1.230 Del    SQL = "DELETE * FROM TW_R13_枠障子グループ最小"   'V1.150 Add
'V1.230 Del    db.Execute SQL                                    'V1.150 Add
    SQL = "DELETE * FROM TW_HOKYOU_HACYU_HINMOKU"     'V1.150 Add
    DB.Execute SQL                                    'V1.150 Add
    SQL = "DELETE * FROM TW_部品ピッキング同梱部品"   'V1.150 Add
    DB.Execute SQL                                    'V1.150 Add
'V1.260 Add Start
    SQL = "DELETE * FROM TW_SEIHIN_移動親"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_帳票累積10"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_TEIS_BUZAI"
    DB.Execute SQL
    SQL = "DELETE * FROM T_色別集計表"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_色別集計表"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_色別集計表_部材色"
    DB.Execute SQL
'V1.260 Add End
'V1.262 Add Start
    SQL = "DELETE * FROM TW_色別集計表_アルミ"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_色別集計表_樹脂"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_KATAZAI_KUMI_明細"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_KATAZAI_KUMI"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_KATAZAI_KUMI_集計"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_KATAZAI_KUMI_セット数集計"
    DB.Execute SQL
'V1.262 Add End
'V1.380 Add Start
    SQL = "DELETE * FROM TW_帳票累積23_2"
    DB.Execute SQL
    SQL = "DELETE * FROM TW_帳票累積24_2"
    DB.Execute SQL
'V1.380 Add End
    SQL = "DELETE * FROM TW_GENPIN"   'V1.500 Add
    DB.Execute SQL                    'V1.150 Add

    Set DB = Nothing
    
    F_PK_TTANMATU_PUPD (0)  'V1.201 Add
End Sub

Private Sub Form_Load()
    SetGamenBackColor
    ' 画面初期位置の再現
    ahtRestoreSize Me
End Sub

Private Sub Form_Unload(Cancel As Integer)
    
    ' 画面初期位置の保存
    ahtSaveSize Me

'V1.350 Add Start
    Dim DB As DAO.Database
    Dim rsMstXA As Recordset
    
    If tgl設計試作 = True Then
        Set DB = CurrentDb
        Set rsMstXA = DB.OpenRecordset("SELECT CODE,CODEMEI FROM TM_HANYOU WHERE KUBUN='XA'")
        
        If rsMstXA.EOF Then Exit Sub
        
        rsMstXA.MoveFirst
        
        '元の工場に戻す
        rsMstXA.Edit
        rsMstXA("CODE") = Me.txtCD_KOJYO_old
        rsMstXA("CODEMEI") = Me.txtCD_KOJYOMEI_old
        rsMstXA.Update
    
        rsMstXA.Close
        Set rsMstXA = Nothing
        Set DB = Nothing
    End If
'V1.350 Add End

End Sub


Private Sub Form_Open(Cancel As Integer)
On Error Resume Next
    
    Call FormOpenInitProc
    Call SetKoujyouMei
    
'V1.350 Add Start
        Me.cmb工場.Enabled = True
        Me.cmb工場.SetFocus
        Me.cmb工場.Text = DLookup("CODEMEI", "Q_T_HANYOU_FA")
        Me.投入日始点コンボ.SetFocus
        Me.cmb工場.Enabled = False
        Me.cmb工場.Visible = False
'V1.350 Add End
    
    Me.Refresh

End Sub

Private Sub Form_Current()
' 標題を更新してﾒﾆｭｰ用ﾌｫｰﾑの項目を代入する

    Me.Caption = Nz(Me![ItemText], "")
    FillOptions
    
End Sub

'---------------------------------------
'    Form表示時の初期処理
'---------------------------------------
Sub FormOpenInitProc()
On Error Resume Next
    '前回選択したの投入課をコンボボックスに表示する
    Me![Cmb_投入課コード] = DLookup("CODE", "Q_TM_HANYOU_LOCAL_XV")
    'ﾃﾞｰﾀﾍﾞｰｽ ｳｨﾝﾄﾞｳを最小化してﾌｫｰﾑを初期化する
    '既定として指定されたﾒﾆｭｰ項目に移動する。
'    Me.Filter = "[ItemNumber] = 0 AND [Argument] = '既定' "
    If Me.Cmb_投入課コード = "(すべて)" Then
        Me.Filter = "[ItemNumber] = 0 AND [Argument] = 'すべて' "
    Else
        Me.Filter = "[ItemNumber] = 0 AND [Argument] = '課別' "
    End If
    Me.FilterOn = True
    
    Call EditQuery_PQ_TB_TNPLAN
    Call EditQuery_PQ_抽出条件
    
    Dim stDocName As String

    stDocName = "MAB_抽出条件更新"
    DoCmd.RunMacro stDocName

    Dim varStartPoint As Variant
   
    If RecordCount("Q_T_抽出条件") > 0 Then
        If IsNull(DMin("条件", "Q_T_抽出条件", "条件>" & DMax("表示用", "T_抽出済データ", "内容='最終'"))) Then
            '前回までの最大
            varStartPoint = DLookup("表示用", "Q_T_抽出条件", "条件=" & _
                                            DMin("条件", "Q_T_抽出条件", "条件>=" & DMax("表示用", "T_抽出済データ", "内容='最終'")))
        Else
            '前回の次
            varStartPoint = DLookup("表示用", "Q_T_抽出条件", "条件=" & _
                                            DMin("条件", "Q_T_抽出条件", "条件>" & DMax("表示用", "T_抽出済データ", "内容='最終'")))
        End If
        
        Me![投入日始点コンボ] = varStartPoint  '前回までの最大もしくはその次
        Me![投入日終点コンボ] = DLookup("表示用", "Q_T_抽出条件", "条件=" & DMax("条件", "Q_T_抽出条件"))   '最大
    Else
    End If
    
    'V1.340 Add Start
        ' TM_HANYOUのENにある投入課が現品票番号検索できるもの
        If DLookup("CODE", "Q_TM_HANYOU_LOCAL_EN") = DLookup("CODE", "Q_TM_HANYOU_LOCAL_XB") Then
            Me.Lbl_現品票番号.Visible = True
            Me.Cmb_現品票番号.Visible = True
        Else
            Me.Lbl_現品票番号.Visible = False
            Me.Cmb_現品票番号.Visible = False
        End If
    'V1.340 Add End
    
End Sub

Private Sub FillOptions()
' ﾒﾆｭｰ用ﾌｫｰﾑの項目を代入する

    ' ﾒﾆｭｰ用ﾌｫｰﾑの項目数
    Const conNumButtons = 15
    
    Dim dbs As Database
    Dim rst As Recordset
    Dim strSQL As String
    Dim intOption As Integer
    
    ' 先頭のﾒﾆｭｰ項目にﾌｫｰｶｽを移動して、項目名がないﾒﾆｭｰ項目を非表示にする
    Me![Option1].SetFocus
    For intOption = 2 To conNumButtons
        Me("Option" & intOption).Visible = False
        Me("OptionLabel" & intOption).Visible = False
    Next intOption
    
    ' ﾒｲﾝのﾒﾆｭｰ用ﾌｫｰﾑを開き、最初の項目を検索する
    Set dbs = CurrentDb()
    strSQL = "SELECT * FROM [Switchboard Items]"
    strSQL = strSQL & " WHERE [ItemNumber] > 0 AND [SwitchboardID]=" & Me![SwitchboardID]
    strSQL = strSQL & " ORDER BY [ItemNumber];"
    Set rst = dbs.OpenRecordset(strSQL)
    
    ' ﾒﾆｭｰ用ﾌｫｰﾑに何も項目がない場合は、ﾒｯｾｰｼﾞを表示する
    ' それ以外の場合は、次のﾒﾆｭｰ項目を代入する
    If (rst.EOF) Then
        Me![OptionLabel1].Caption = "このﾒﾆｭｰに表示できる項目がありません。"
    Else
        While (Not (rst.EOF))
            Me("Option" & rst![ItemNumber]).Visible = True
            Me("OptionLabel" & rst![ItemNumber]).Visible = True
            Me("OptionLabel" & rst![ItemNumber]).Caption = rst![ItemText]
            rst.MoveNext
        Wend
    End If

    ' ﾒﾆｭｰ用ﾌｫｰﾑのﾚｺｰﾄﾞｾｯﾄを閉じる
    rst.Close
    dbs.Close

End Sub

Private Function HandleButtonClick(intBtn As Integer)
' この関数は、ﾒﾆｭｰ項目のﾎﾞﾀﾝがｸﾘｯｸされたときに呼ばれます。
' 変数 intBtn が、ｸﾘｯｸされた項目を表します。

    ' 実行できるｺﾏﾝﾄﾞの定数定義
    Const conCmdGotoSwitchboard = 1
    Const conCmdOpenFormAdd = 2
    Const conCmdOpenFormBrowse = 3
    Const conCmdOpenReport = 4
    Const conCmdCustomizeSwitchboard = 5
    Const conCmdExitApplication = 6
    Const conCmdRunMacro = 7
    Const conCmdRunCode = 8

    ' 特別な場合のｴﾗｰ番号
    Const conErrDoCmdCancelled = 2501
    
    Dim dbs As Database
    Dim rst As Recordset

On Error GoTo HandleButtonClick_Err

    ' ｸﾘｯｸされたﾒﾆｭｰ項目を検索します
    Set dbs = CurrentDb()
    Set rst = dbs.OpenRecordset("Switchboard Items", dbOpenDynaset)
    rst.FindFirst "[SwitchboardID]=" & Me![SwitchboardID] & " AND [ItemNumber]=" & intBtn
    
    ' 見つからなかった場合は、ｴﾗｰﾒｯｾｰｼﾞを表示します。
    If (rst.NoMatch) Then
        MsgBox "ﾒﾆｭｰ用ﾌｫｰﾑの項目が見つかりませんでした。"
        rst.Close
        dbs.Close
        Exit Function
    End If
    
    Select Case rst![Command]
        
        ' 別のﾒﾆｭｰ用ﾌｫｰﾑへ移動する
        Case conCmdGotoSwitchboard
            Me.Filter = "[ItemNumber] = 0 AND [SwitchboardID]=" & rst![Argument]
            
        ' ﾌｫｰﾑを追加ﾓｰﾄﾞで開く
        Case conCmdOpenFormAdd
            DoCmd.OpenForm rst![Argument], , , , acAdd

        ' ﾌｫｰﾑを編集ﾓｰﾄﾞで開く
        Case conCmdOpenFormBrowse
            DoCmd.OpenForm rst![Argument]

        ' ﾚﾎﾟｰﾄを開く
        Case conCmdOpenReport
            DoCmd.OpenReport rst![Argument], acPreview

        ' ﾒﾆｭｰ用ﾌｫｰﾑの編集
        Case conCmdCustomizeSwitchboard
            ' ﾒﾆｭｰ用ﾌｫｰﾑ ﾋﾞﾙﾀﾞがｾｯﾄｱｯﾌﾟされていない場合
            On Error Resume Next
            Application.Run "WZMAIN80.sbm_Entry"
            If (Err <> 0) Then MsgBox "ｳｨｻﾞｰﾄﾞがｾｯﾄｱｯﾌﾟされていません。"
            On Error GoTo 0
            ' ﾌｫｰﾑの再表示
            Me.Filter = "[ItemNumber] = 0 AND [Argument] = '既定' "
            Me.Caption = Nz(Me![ItemText], "")
            FillOptions

        ' ﾃﾞｰﾀﾍﾞｰｽを閉じる
        Case conCmdExitApplication
'            DoCmd.RunMacro ("MBX_帳票出力用全テーブル削除処理")
'            CloseCurrentDatabase
            DoCmd.Quit

        ' ﾏｸﾛの実行
        Case conCmdRunMacro
            DoCmd.RunMacro rst![Argument]

        ' ﾓｼﾞｭｰﾙの実行
        Case conCmdRunCode
            Application.Run rst![Argument]

        ' 他のｺﾏﾝﾄﾞの実行
        Case Else
            MsgBox "不明なｺﾏﾝﾄﾞです。"
    
    End Select

    ' ﾚｺｰﾄﾞｾｯﾄとﾃﾞｰﾀﾍﾞｰｽを閉じる
    rst.Close
    dbs.Close
    
HandleButtonClick_Exit:
    Exit Function

HandleButtonClick_Err:
    ' 実行内容がﾕｰｻﾞｰによってｷｬﾝｾﾙされた場合、
    ' ﾒｯｾｰｼﾞを表示しないで次に進む
    If (Err = conErrDoCmdCancelled) Then
        Resume Next
    Else
        MsgBox "ｴﾗｰが発生したため、ｺﾏﾝﾄﾞは実行できませんでした。", vbCritical
        Resume HandleButtonClick_Exit
    End If
    
End Function

Private Sub 工場名_DblClick(Cancel As Integer)
    If GetKeyState(vbKeyShift) < 0 Then
        'シフトキー'押下中なら
        Call ChangeCdKojyo      '工場コード切替
        
        Me.Cmb_投入課コード.Requery
        Call SetKoujyouMei
        
    ElseIf GetKeyState(vbKeyControl) < 0 Then
        'コントロールキー押下中なら
        DoCmd.OpenQuery "Q_修正履歴情報", acViewNormal, acReadOnly
    End If

End Sub

Private Sub 工場名_Exit(Cancel As Integer)
    Call FormOpenInitProc   '画面表示初期処理
End Sub

Private Sub 帳票データ作成ボタン_Click()
On Error GoTo Err_帳票データ作成ボタン_Click

    Dim stDocName As String
    Dim RESPONSE As Variant
    Dim strStartPoint As Variant

'V1.540 Add Start
    '現品票番号が入力されていた場合
    If Me![Cmb_現品票番号] <> "" Then
        If Me![Cmb_投入課コード] = DLookup("CODE", "Q_TM_HANYOU_LOCAL_EN") Then
            ' パススルークエリ実行
            EditQuery_T_GENPIN_TO_CYUMON (Me![Cmb_現品票番号])
        
            If IsNull(DLookup("CYUMON_NO", "PQ_T_GENPIN_TO_CYUMON")) Then
                MsgBox "現品票番号→注文番号の検索できませんでした。正しい現品票番号を入力してください。", vbCritical
                Exit Sub
            Else
                Me![注文番号] = DLookup("CYUMON_NO", "PQ_T_GENPIN_TO_CYUMON")
            End If
        Else
            Me![Cmb_現品票番号] = ""
        End If
    End If
'V1.540 Add End

'V1.183 Add Start 'Del 2009/05/11
    If Not IsNull(Me![注文番号]) Then
        stDocName = "MA002_帳票データ作成_注文番号"
        DoCmd.RunMacro stDocName
    Else
'V1.183 Add End
        If IsNull(Me![投入日始点コンボ]) = True Then
            RESPONSE = MsgBox("範囲の始点を指定してください。", vbOKOnly, "始点未設定")
            DoCmd.GoToControl "投入日始点コンボ"
            Exit Sub
        End If
    
'V1.183 Del        stDocName = "MA_帳票データ作成"
        stDocName = "MA001_帳票データ作成_投入日"
        DoCmd.RunMacro stDocName
    
        If IsNull(DMin("条件", "Q_T_抽出条件", "条件>" & DMax("表示用", "T_抽出済データ", "内容='最終'"))) Then
            strStartPoint = DLookup("表示用", "Q_T_抽出条件", "条件=" & _
                                            DMin("条件", "Q_T_抽出条件", "条件>=" & DMax("表示用", "T_抽出済データ", "内容='最終'")))
        Else
            strStartPoint = DLookup("表示用", "Q_T_抽出条件", "条件=" & _
                                            DMin("条件", "Q_T_抽出条件", "条件>" & DMax("表示用", "T_抽出済データ", "内容='最終'")))
        End If
        
        Me![投入日始点コンボ] = strStartPoint  '前回までの最大もしくはその次
        Me![投入日終点コンボ] = DLookup("表示用", "Q_T_抽出条件", "条件=" & DMax("条件", "Q_T_抽出条件"))   '最大
    End If
    
    Me.Refresh

Exit_帳票データ作成ボタン_Click:
    Exit Sub

Err_帳票データ作成ボタン_Click:
    If Err.Number <> 2001 Then  '2001:マクロで『全マクロ中止』の場合
        MsgBox Err.Description
    End If
    Resume Exit_帳票データ作成ボタン_Click
    
End Sub

Private Sub 帳票出力メンテナンスボタン_Click()
    Dim stDocName As String
    
    stDocName = "MBW_帳票出力メンテナンス処理"
    DoCmd.RunMacro stDocName
End Sub

Private Sub 帳票標記メンテナンスボタン_Click()
    Dim stDocName As String
    
    stDocName = "MBY_帳票標記メンテナンス処理"
    DoCmd.RunMacro stDocName
End Sub

Private Sub 投入日始点コンボ_AfterUpdate()

    Me![投入日終点コンボ] = [投入日始点コンボ].[Column](0)
    DoCmd.Requery "投入日終点コンボ"

End Sub


Private Sub 投入日始点コンボ_Enter()
On Error GoTo Err_投入日始点コンボ_Enter

    DoCmd.SetWarnings False
    DoCmd.Hourglass True

    Dim stDocName As String

    stDocName = "MAB_抽出条件更新"
    DoCmd.RunMacro stDocName
    
    If RecordCount("Q_T_抽出条件") > 0 Then
        Me![投入日始点コンボ] = DLookup("表示用", "Q_T_抽出条件", "条件=" & DMax("条件", "Q_T_抽出条件"))
        Me![投入日終点コンボ] = Me![投入日始点コンボ]
    Else
    End If
    Me.Refresh

    DoCmd.Hourglass False
    DoCmd.SetWarnings True

'V1.540 Add Start
    '投入課550の場合
    If Me![Cmb_投入課コード] = DLookup("CODE", "Q_TM_HANYOU_LOCAL_EN") Then
        '現品票番号と注文番号を初期化
        Me![Cmb_現品票番号] = ""
        Me![注文番号] = Null
        ' パススルークエリ実行
        EditQuery_T_GENPIN_TO_CYUMON (Me![Cmb_現品票番号])
    End If
'V1.540 Add End

Exit_投入日始点コンボ_Enter:
    Exit Sub

Err_投入日始点コンボ_Enter:
    MsgBox Err.Description
    Resume Exit_投入日始点コンボ_Enter
    
End Sub

Private Sub 投入日終点コンボ_Enter()
    Dim RESPONSE As Variant
    
    If IsNull(Me![投入日始点コンボ]) = True Then
        RESPONSE = MsgBox("範囲の始点を指定してください。", vbOKOnly, "始点未設定")
        DoCmd.GoToControl "投入日始点コンボ"
    End If

'V1.540 Add Start
    '投入課550の場合
    If Me![Cmb_投入課コード] = DLookup("CODE", "Q_TM_HANYOU_LOCAL_EN") Then
        '現品票番号と注文番号を初期化
        Me![Cmb_現品票番号] = ""
        Me![注文番号] = Null
        ' パススルークエリ実行
        EditQuery_T_GENPIN_TO_CYUMON (Me![Cmb_現品票番号])
    End If
'V1.540 Add End

End Sub

Function SetGamenBackColor()
    Dim blnVisible As Boolean
    
    If DLookup("TEXT1", "TM_HANYOU", "KUBUN='AA' AND CODE='XXX'") = _
       DLookup("DBNAME", "TM_オラクル接続文字列") And _
       DLookup("TEXT2", "TM_HANYOU", "KUBUN='AA' AND CODE='XXX'") = _
       DLookup("USERPASSWORD", "TM_オラクル接続文字列") Then
        blnVisible = False                  '接続先＝本番
        Me.section(0).BackColor = DLookup("TEXT1", "TM_HANYOU", "KUBUN='AD' AND CODE='本番'")     '本番色
    Else
        blnVisible = True   '接続先＝テスト
'V1.180 Del Start
'        Me.lbl接続先.Caption = DLookup("USERPASSWORD", "TM_オラクル接続文字列") & vbNewLine & _
'                               "@" & DLookup("DBNAME", "TM_オラクル接続文字列")
'V1.180 Del End
'V1.180 Add Start
        Me.lbl接続先.Caption = Mid(DLookup("USERPASSWORD", "TM_オラクル接続文字列"), 1, InStr(1, DLookup("USERPASSWORD", "TM_オラクル接続文字列"), "/") - 1) & vbNewLine & _
                               "@" & DLookup("DBNAME", "TM_オラクル接続文字列")
'V1.180 Add End
        Me.section(0).BackColor = DLookup("TEXT1", "TM_HANYOU", "KUBUN='AD' AND CODE='テスト'")   '赤
    End If
    
    Me.lbl接続先_タイトル.Visible = blnVisible
    Me.lbl接続先.Visible = blnVisible

End Function

'-------------------------------------------------------
'工場コードを切替えます。隠し機能
'  ダブルクリック＆シフトキー押下が変更条件
'-------------------------------------------------------
Sub ChangeCdKojyo()
On Error Resume Next
    Dim DB As Database
    Dim rsMstXA As Recordset
    Dim rsMstXX As Recordset
    Dim SQL As String
    
    Set DB = CurrentDb
    
    Set rsMstXA = DB.OpenRecordset("SELECT CODE,CODEMEI FROM TM_HANYOU WHERE KUBUN='XA'")
    
    If rsMstXA.EOF Then Exit Sub
    
    rsMstXA.MoveFirst
    
    SQL = ""
    SQL = SQL & "SELECT CODE,CODEMEI FROM TM_HANYOU "
    SQL = SQL & "WHERE KUBUN='XX' "
    SQL = SQL & "AND CODE <> '" & rsMstXA("CODE") & "'"
    SQL = SQL & "ORDER BY CODE"
    
    Set rsMstXX = DB.OpenRecordset(SQL)
    If rsMstXX.EOF Then Exit Sub
    
    '現在の工場コードの次を検索
    rsMstXX.FindFirst "CODE > '" & rsMstXA("CODE") & "'"
    
    If rsMstXX.NoMatch Then
        '最後の工場コードの場合、先頭を検索
        rsMstXX.MoveFirst
    End If
    
    '検索した工場コードを設定
    rsMstXA.Edit
    rsMstXA("CODE") = rsMstXX("CODE")
    rsMstXA("CODEMEI") = rsMstXX("CODEMEI")
    rsMstXA.Update


    rsMstXA.Close
    rsMstXX.Close
    Set rsMstXA = Nothing
    Set rsMstXX = Nothing
    Set DB = Nothing
End Sub

Sub SetKoujyouMei()
    Me.工場名 = DLookup("CODEMEI", "Q_TM_HANYOU_LOCAL_XA")
    
'V1.350 Add Start
'V1.381 Del    If DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA") = "4000" Or _
       DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA") = "3900" Or _
       DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA") = "4900" Then
'V1.445 Del    If DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA") = "4000" Or _
       DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA") = "3000" Or _
       DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA") = "5000" Or _
       DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA") = "8000" Or _
       DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA") = "7000" Or _
       DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA") = "3900" Or _
       DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA") = "4900" Then  'V1.381 Add
    If Nz(DLookup("設計試作", "Q_TM_HANYOU_LOCAL_XA_設計試作対象"), "0") = "1" Then  'V1.445 Add
        Me.tgl設計試作.Visible = True
    Else
        Me.tgl設計試作.Visible = False
    End If
'V1.350 Add End
End Sub


'V1.350 Add Start
Private Sub cmb工場_AfterUpdate()
On Error Resume Next
    Dim DB As Database
    Dim rsMstXA As Recordset
    Dim SQL As String
    
    Set DB = CurrentDb
    
    Set rsMstXA = DB.OpenRecordset("SELECT CODE,CODEMEI FROM TM_HANYOU WHERE KUBUN='XA'")
    
    If rsMstXA.EOF Then Exit Sub
    
    rsMstXA.MoveFirst
    
    'コンボボックスで選択した工場コードを設定
    rsMstXA.Edit
    If tgl設計試作 = False Or IsNull(tgl設計試作) = True Then
'        rsMstXA("CODE") = Me.工場名
'        rsMstXA("CODEMEI") = DLookup("CODEMEI", "Q_TM_HANYOU_LOCAL_XX", "CODE = '" & Me.工場名 & "'")
    Else
        rsMstXA("CODE") = Me.cmb工場
        rsMstXA("CODEMEI") = DLookup("CODEMEI", "Q_T_HANYOU_FA", "TEXT1 = '" & Me.cmb工場 & "'")
    End If
    rsMstXA.Update

    rsMstXA.Close
    Set rsMstXA = Nothing
    Set DB = Nothing
    
    Me.Cmb_投入課コード.Requery
    Me.Refresh
    Me.Cmb_投入課コード.SetFocus

End Sub

Private Sub tgl設計試作_Click()
    Dim DB As Database
    Dim rsMstXA As Recordset
    Dim SQL As String
    Dim stDocName As String

    If tgl設計試作 = True Then
        '元の工場のバックアップ
        Me.txtCD_KOJYO_old.Value = DLookup("CODE", "Q_TM_HANYOU_LOCAL_XA")
        Me.txtCD_KOJYOMEI_old.Value = DLookup("CODEMEI", "Q_TM_HANYOU_LOCAL_XA")
        
        Me.工場名 = DLookup("CODEMEI", "Q_T_HANYOU_FA")
    
        Me.工場名.Visible = False
        Me.cmb工場.Visible = True
        Me.cmb工場.Enabled = True
'        Me.cmb工場.RowSource = "SELECT Q_T_HANYOU_FA.CODEMEI, Q_T_HANYOU_FA.TEXT1 FROM Q_T_HANYOU_FA;"
        Me.cmb工場.SetFocus
'        Me![cmb工場].Text = DLookup("CODEMEI", "Q_T_HANYOU_FA")
        
        Set DB = CurrentDb
        Set rsMstXA = DB.OpenRecordset("SELECT CODE,CODEMEI FROM TM_HANYOU WHERE KUBUN='XA'")
        
        If rsMstXA.EOF Then Exit Sub
        rsMstXA.MoveFirst
        
        'コンボボックスで選択した工場コードを設定
        rsMstXA.Edit
        rsMstXA("CODE") = Me.cmb工場
        rsMstXA("CODEMEI") = DLookup("CODEMEI", "Q_T_HANYOU_FA", "TEXT1 = '" & Me.cmb工場 & "'")
        rsMstXA.Update
    
        rsMstXA.Close
        Set rsMstXA = Nothing
        Set DB = Nothing
        
        DoCmd.Hourglass True

        Call EditQuery_PQ_TB_TNPLAN
        Call EditQuery_PQ_抽出条件

        stDocName = "MAB_抽出条件更新"
        DoCmd.RunMacro stDocName
        DoCmd.Hourglass False
    
        Me.Cmb_投入課コード.Requery
        Me.Refresh
    Else
        Set DB = CurrentDb
        
        Set rsMstXA = DB.OpenRecordset("SELECT CODE,CODEMEI FROM TM_HANYOU WHERE KUBUN='XA'")
        
        If rsMstXA.EOF Then Exit Sub
        
        rsMstXA.MoveFirst
        
        '元の工場に戻す
        rsMstXA.Edit
        rsMstXA("CODE") = Me.txtCD_KOJYO_old
        rsMstXA("CODEMEI") = Me.txtCD_KOJYOMEI_old
        rsMstXA.Update
    
        rsMstXA.Close
        Set rsMstXA = Nothing
        Set DB = Nothing

        'Me.cmb工場.RowSource = "Q_TM_HANYOU_LOCAL_XX"
        Me.cmb工場.Enabled = False
        Me.cmb工場.Visible = False
        Me.工場名.Visible = True
        Me.工場名 = Me.txtCD_KOJYOMEI_old
        
        Call SetKoujyouMei
        
        DoCmd.Hourglass True

        Call EditQuery_PQ_TB_TNPLAN
        Call EditQuery_PQ_抽出条件

        stDocName = "MAB_抽出条件更新"
        DoCmd.RunMacro stDocName
        DoCmd.Hourglass False
        
        Me.Cmb_投入課コード.Requery
        Me.Refresh
    End If
    
    Me.Cmb_投入課コード.SetFocus

End Sub
'V1.350 Add End
